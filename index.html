<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced MQTT Web Client</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            text-align: center;
            padding: 50px;
        }
        #messages {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            width: 50%;
            margin-left: auto;
            margin-right: auto;
            background-color: white;
        }
        #status {
            font-weight: bold;
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            width: 200px;
            margin-left: auto;
            margin-right: auto;
        }
        .connected {
            background-color: #28a745;
            color: white;
        }
        .disconnected {
            background-color: #dc3545;
            color: white;
        }
        input, button {
            padding: 10px;
            margin: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <h1>Advanced MQTT Web Client</h1>

    <!-- Input untuk URL Broker -->
    <div class="form-group">
        <input id="brokerUrl" type="text" placeholder="Broker URL (e.g. mqtt-dashboard.com)" style="width: 300px;" value="mqtt-dashboard.com">
        <input id="brokerPort" type="text" placeholder="Port (e.g. 1883)" style="width: 100px;" value="1883">
        <button onclick="connectMQTT()">Connect</button>
    </div>
    
    <!-- Indikator Status Koneksi -->
    <div id="status" class="disconnected">Disconnected</div>

    <!-- Input untuk topik dan pesan -->
    <div class="form-group">
        <input id="topic" type="text" placeholder="Topic (e.g. test/topic)" style="width: 300px;" value="test/topic">
        <input id="message" type="text" placeholder="Message (e.g. Hello World)" style="width: 300px;" value="Hello World">
        <button onclick="publishMessage()">Publish</button>
    </div>

    <!-- Input untuk subscribe ke topik -->
    <div class="form-group">
        <input id="subscribeTopic" type="text" placeholder="Subscribe to Topic (e.g. test/topic)" style="width: 300px;" value="test/topic">
        <button onclick="subscribeTopic()">Subscribe</button>
    </div>

    <!-- Area untuk menampilkan pesan -->
    <div id="messages"></div>

    <script>
        let client;

        // Fungsi untuk connect ke broker MQTT
        function connectMQTT() {
            const brokerUrl = document.getElementById('brokerUrl').value;
            const brokerPort = document.getElementById('brokerPort').value;

            // Membentuk URL broker dengan port
            const fullBrokerUrl = `mqtt://${brokerUrl}:${brokerPort}`; // Menggunakan mqtt://

            // Membuat koneksi ke broker
            client = mqtt.connect(fullBrokerUrl);

            // Indikator jika berhasil connect
            client.on('connect', () => {
                document.getElementById('messages').innerHTML += `<p>Connected to broker ${fullBrokerUrl}</p>`;
                document.getElementById('status').innerText = 'Connected';
                document.getElementById('status').className = 'connected';
            });

            // Indikator jika gagal connect
            client.on('error', (error) => {
                document.getElementById('messages').innerHTML += `<p style="color: red;">Failed to connect: ${error.message}</p>`;
                document.getElementById('status').innerText = 'Disconnected';
                document.getElementById('status').className = 'disconnected';
            });

            // Indikator jika disconnect
            client.on('close', () => {
                document.getElementById('messages').innerHTML += `<p style="color: red;">Disconnected from broker</p>`;
                document.getElementById('status').innerText = 'Disconnected';
                document.getElementById('status').className = 'disconnected';
            });

            // Menerima pesan dari broker
            client.on('message', (topic, message) => {
                document.getElementById('messages').innerHTML += `<p><strong>${topic}:</strong> ${message.toString()}</p>`;
            });
        }

        // Fungsi untuk publish pesan ke topik MQTT
        function publishMessage() {
            const topic = document.getElementById('topic').value;
            const message = document.getElementById('message').value;

            if (client && topic && message) {
                client.publish(topic, message);
                document.getElementById('messages').innerHTML += `<p>Published: <strong>${message}</strong> to <strong>${topic}</strong></p>`;
            } else {
                alert('Make sure to connect to the broker, and fill in both the topic and message fields.');
            }
        }

        // Fungsi untuk subscribe ke topik tertentu
        function subscribeTopic() {
            const topic = document.getElementById('subscribeTopic').value;

            if (client && topic) {
                client.subscribe(topic);
                document.getElementById('messages').innerHTML += `<p>Subscribed to topic: <strong>${topic}</strong></p>`;
            } else {
                alert('Make sure to connect to the broker and fill in the topic.');
            }
        }
    </script>
</body>
</html>
